# Shoulder IQ Assessment Tool - Copilot Instructions

## Architecture Overview

This is a full-stack medical assessment application with a React/TypeScript frontend and Node.js/Express backend for shoulder condition evaluations.

**Frontend:** `/client/` - React 18 + TypeScript + Vite + Tailwind CSS  
**Backend:** `/server/` - Node.js + Express + MongoDB + Anthropic Claude API  
**File Structure:** Session-based uploads in `/server/public/uploads/assessment_files/{session-id}/`

## Critical Development Patterns

### Form State Management
- **Context Pattern:** All form data flows through `FormContext.tsx` using a centralized state object
- **Session IDs:** Each form session gets a unique ID (`session-{timestamp}-{random}`) for file organization
- **Step Navigation:** 7-step wizard with validation checks before navigation via `isStepValid()`
- **Data Structure:** Main form data lives in `formData.ts` with nested interfaces (Demographics, PainAreas, Imaging, etc.)

### File Upload Workflow
1. **Temporary Upload:** Files first go to `/uploads/temp/` via `/api/upload/imaging-file`
2. **Session Move:** Files move to `/uploads/assessment_files/{sessionId}/` on form progression
3. **Database Reference:** Only file paths stored in MongoDB, not file content
4. **Public Access:** Files served statically via `SERVER_BASE_URL/uploads/assessment_files/...`

### Environment Configuration
- **Port Synchronization:** `SERVER_PORT` in `.env` MUST match `vite.config.ts` proxy target port
- **API Keys:** Claude API key required for AI summary generation
- **Email:** Mailgun SMTP for automated notifications to patients/doctors
- **Database:** MongoDB connection via `MONGODB_URI`

## Key Integration Points

### AI Summary Generation
```javascript
// Located in app.js, uses prompt-builder.js
const comprehensivePrompt = generateComprehensivePrompt(formData);
const claudeResponse = await anthropic.messages.create({
  model: "claude-3-sonnet-20240229",
  max_tokens: 4000,
  messages: [{ role: "user", content: comprehensivePrompt }]
});
```

### Frontend-Backend Data Flow
- **API Base:** All requests proxy through `/api` (configured in vite.config.ts)
- **Form Submission:** Final submission to `/api/assessment/submit` triggers AI processing and email notifications
- **File Upload:** Separate endpoint `/api/upload/imaging-file?formSessionId={id}`

### Database Schema Critical Fields
```javascript
// Assessment.js model
{
  sessionId: String,        // Links to file upload directory
  aiSummary: String,        // Generated by Claude API
  painMapImages: [String],  // Array of file paths
  imaging: [{
    documentName: String,   // File path reference
    jointRegions: [String]  // Multi-select from frontend (Left Shoulder, Right Shoulder)
  }]
}
```

## Development Commands

```bash
# Development (requires 2 terminals)
cd server && npm start           # Backend on port from .env
cd client && npm run dev         # Frontend on port 5173

# Production Build
cd client && npm run build       # Generates dist/ folder
# Deploy dist/ and server/ together

# File Permissions
# Ensure server/public/uploads/ is writable by Node.js process
```

## Medical Form Specific Patterns

### Pain Mapping
- Interactive body diagrams with click-to-select regions
- Pain intensity sliders (1-10 scale) 
- Generates PNG images saved to session directory

### Conditional Fields
- **Referring Doctor:** Shows additional fields only if "Yes" selected
- **Surgery History:** Dynamic surgery entry forms
- **Imaging Studies:** Per-type conditional file uploads with joint region selection (Left Shoulder, Right Shoulder)

### Validation Logic
- Required fields enforced before step navigation
- Email format validation for notifications
- File type restrictions: PDF, JPG, PNG only (10MB limit)

## Common Issues & Solutions

- **Port Mismatch:** If API calls fail, verify `SERVER_PORT` matches vite proxy
- **File Upload 404:** Check session directory permissions and path construction
- **Email Failures:** Verify Mailgun credentials and sender/recipient addresses
- **AI Summary Errors:** Check Claude API key and prompt length limits
- **Theme Issues:** Dark/light mode handled via Tailwind classes with `dark:` prefixes

## Security Considerations

- Dashboard protected by `DASHBOARD_PASSWORD` environment variable
- Session-based file isolation prevents cross-user access
- File sanitization in upload handlers prevents directory traversal
- CORS configured for cross-origin requests in development
