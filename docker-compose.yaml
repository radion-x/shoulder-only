version: '3.8'

services:
  # React Frontend (Nginx)
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        - VITE_SERVER_BASE_URL=${VITE_SERVER_BASE_URL}
    expose:
      - "80"
    labels:
      - coolify.managed=true
      - coolify.http=true
    networks:
      - coolify

  # Node.js Backend (Express)
  server:
    build:
      context: ./server
      dockerfile: Dockerfile
    expose:
      - "3000"
    environment:
      - SERVER_PORT=3000
      - MONGODB_URI=${MONGODB_URI}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY}
      - MAILGUN_API_KEY=${MAILGUN_API_KEY}
      - MAILGUN_DOMAIN=${MAILGUN_DOMAIN}
      - EMAIL_SENDER_ADDRESS=${EMAIL_SENDER_ADDRESS}
      - EMAIL_RECIPIENT_ADDRESS=${EMAIL_RECIPIENT_ADDRESS}
      - BCC_EMAIL_RECIPIENT_ADDRESS=${BCC_EMAIL_RECIPIENT_ADDRESS}
      - DASHBOARD_PASSWORD=${DASHBOARD_PASSWORD}
      - SESSION_SECRET=${SESSION_SECRET}
      - SERVER_BASE_URL=${SERVER_BASE_URL}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS}
      - COOKIE_DOMAIN=${COOKIE_DOMAIN}
      - TRUST_PROXY=${TRUST_PROXY}
      - NODE_ENV=production
    labels:
      - coolify.managed=true
      - coolify.http=true
    volumes:
      - uploads-data:/app/public/uploads
    networks:
      - coolify

networks:
  coolify:
    external: true

volumes:
  uploads-data:
